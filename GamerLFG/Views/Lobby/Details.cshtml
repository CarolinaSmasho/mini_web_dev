@model GamerLFG.Models.Lobby
@{
    ViewData["Title"] = "Mission Briefing";
    var hostName = ViewData["HostName"] as string ?? "Unknown";
    var memberMap = ViewData["MemberMap"] as Dictionary<string, GamerLFG.Models.User> ?? new Dictionary<string, GamerLFG.Models.User>();
}

@{
    var currentUserId = Context.Session.GetString("UserId");
    var isHost = !string.IsNullOrEmpty(currentUserId) && Model.HostId == currentUserId;
    var isMember = ViewData["IsMember"] as bool? ?? false;
    var pendingApp = ViewData["PendingApplication"] as GamerLFG.Models.Application;
    var pendingApps = ViewData["PendingApplications"] as List<GamerLFG.Models.Application> ?? new List<GamerLFG.Models.Application>();
    var applicantMap = ViewData["ApplicantMap"] as Dictionary<string, GamerLFG.Models.User> ?? new Dictionary<string, GamerLFG.Models.User>();
    var endorsedUserIds = ViewData["EndorsedUserIds"] as HashSet<string> ?? new HashSet<string>();
}

@if (isHost)
{
    <main>
        <div>
            <!-- Hero section -->
            <div>
                <img src="@(string.IsNullOrEmpty(Model.PictureUrl) ? "https://images.unsplash.com/photo-1542751371-adc38448a05e?auto=format&fit=crop&w=1200&q=80" : Model.PictureUrl)" alt="@Model.Game" />
                
                <div>
                    <button onclick="toggleRecruitment('@Model.Id')" id="toggleRecruitHero">
                        <span>@(Model.IsRecruiting ? "lock_open ðŸ”“" : "lock ðŸ”’")</span> 
                        <span>@(Model.IsRecruiting ? "Close Recruitment" : "Open Recruitment")</span> 
                    </button>

                    <br />

                    <button onclick="quickChangeBackground()">
                        <span>image</span> Quick Change
                    </button>
                    
                    <br />

                    <a asp-action="Edit" asp-route-id="@Model.Id">
                        <span>edit</span> Edit Mission
                    </a>

                    
                </div>
                <div>
                    <div>
                        <span>Host Command Center</span>
                        <span>@Model.Game</span>
                    </div>
                    <h1>@Model.Title</h1>
                </div>
            </div>

            <hr />
            <!-- Personnel Management -->
            <div>
                <div>
                    <h3>Personnel Management</h3>
                    <p>Manage your active squad and recruits</p>
                </div>
                <div>
                    <span>@Model.CurrentPlayers / @Model.MaxPlayers</span>
                    <button onclick="toggleRecruitment('@Model.Id')">
                        @(Model.IsRecruiting ? "RECRUITING ACTIVE" : "RECRUITING PAUSED")
                    </button>
                </div>

                <!-- Squad List -->
                <div>
                    @foreach (var member in Model.Members)
                    {
                        var user = memberMap.ContainsKey(member.UserId) ? memberMap[member.UserId] : null;
                        <div>
                            @if (!member.IsHost) {
                                <button onclick="kickMember('@member.UserId', this)">
                                    <span>close</span>
                                </button>
                            }
                            <div>
                                <img src="@(user?.AvatarUrl ?? "https://api.dicebear.com/7.x/avataaars/svg?seed=" + member.UserId)" width="40" height="40" />
                                <div>
                                    <a href="@Url.Action("FriendProfile", "User", new { id = user?.Username ?? "" })">@(user?.Username ?? "Unknown")</a>
                                    <p>@member.AssignedRole</p>
                                </div>
                            </div>
                        </div>
                    }
                </div>
                <hr />

                <!-- Applications -->
                <div>
                    <h4>Deployment Requests (@pendingApps.Count)</h4>
                    @if (pendingApps.Any())
                    {
                        @foreach (var app in pendingApps)
                        {
                            var applicant = applicantMap.ContainsKey(app.UserId) ? applicantMap[app.UserId] : null;
                            <div>
                                <img src="@(applicant?.AvatarUrl ?? "https://api.dicebear.com/7.x/avataaars/svg?seed=" + app.UserId)" width="40" height="40" />
                                <div>
                                    <h5>@(applicant?.Username ?? "Unknown")</h5>
                                    <p>"@app.Message"</p>
                                </div>
                                <div>
                                    <button onclick="rejectApplicant('@app.Id', this)">Reject</button>
                                    <button onclick="recruitApplicant('@app.Id', this)">Recruit</button>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <p>No pending recruitment requests</p>
                    }
                </div>
            </div>
            <hr />



            <!-- Mission Intelligence -->
            <div>
                <h3>Mission Intelligence</h3>
                @if (Model.IsCompleted)
                {
                    <p>MISSION COMPLETED</p>
                }
                else
                {
                    <p>Tactical Timeline</p>
                    <p>Recruit Until: @(Model.RecruitmentDeadline?.ToLocalTime().ToString("f") ?? "TBD")</p>
                    @if (Model.RecruitmentDeadline.HasValue && Model.RecruitmentDeadline > DateTime.UtcNow)
                    {
                        <div id="countdown" data-deadline="@Model.RecruitmentDeadline.Value.ToString("O")">
                            <p>00:00:00</p>
                        </div>
                    }
                    <p>Session: @(Model.SessionStartTime?.ToLocalTime().ToString("HH:mm") ?? "??:??") - @(Model.SessionEndTime?.ToLocalTime().ToString("HH:mm") ?? "??:??")</p>
                }

                <div>
                    @foreach(var mood in Model.Moods) {
                        <span>@mood</span>
                    }
                </div>

                @if (!Model.IsCompleted)
                {
                    <button onclick="completeSession('@Model.Id')">COMPLETE MISSION</button>
                }
                <form asp-action="Delete" asp-route-id="@Model.Id" method="post" onsubmit="return confirm('TERMINATE LOBBY?');">
                    @Html.AntiForgeryToken()
                    <button type="submit">TERMINATE LOBBY</button>
                </form>
            </div>
            <hr />

            <!-- Host Info -->
            <div>
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=@hostName" width="48" height="48" />
                <div>
                    <h4>@hostName</h4>
                    <p>Mission Commander</p>
                </div>
            </div>
        </div>
    </main>
}
else
{
    <main>
        <div>
            <!-- Hero Section -->
            <div>
                <img src="@(string.IsNullOrEmpty(Model.PictureUrl) ? "https://images.unsplash.com/photo-1542751371-adc38448a05e?auto=format&fit=crop&w=1200&q=80" : Model.PictureUrl)" alt="@Model.Game" />
                <h1>@Model.Title</h1>
                <p>@Model.Description</p>
            </div>

            <!-- Squad -->
            <div>
                <h3>Squad Composition</h3>
                <p>@(Model.MaxPlayers - Model.CurrentPlayers) slots remaining</p>
                <p>@Model.PlayerIds.Count / @Model.MaxPlayers</p>
                
                @foreach (var playerId in Model.PlayerIds)
                {
                    var player = memberMap.ContainsKey(playerId) ? memberMap[playerId] : null;
                    var playerIsHost = playerId == Model.HostId;
                    <div>
                        <img src="@(player?.AvatarUrl ?? "https://api.dicebear.com/7.x/avataaars/svg?seed=" + playerId)" width="40" height="40" />
                        <a href="@Url.Action("FriendProfile", "User", new { id = player?.Username ?? "" })">@(player?.Username ?? "Unknown")</a>
                        @if (playerIsHost) { <span>Host</span> }
                    </div>
                }
            </div>

            @if (Model.IsCompleted && isMember)
            {
                <div>
                    <h3>DEBRIEFING & KARMA EVALUATION</h3>
                    @foreach (var memberId in Model.PlayerIds)
                    {
                        if (memberId == currentUserId) continue;
                        var player = memberMap.ContainsKey(memberId) ? memberMap[memberId] : null;
                        <div>
                            <img src="@(player?.AvatarUrl ?? "https://api.dicebear.com/7.x/avataaars/svg?seed=" + memberId)" width="64" height="64" />
                            <a href="@Url.Action("FriendProfile", "User", new { id = player?.Username ?? "" })">@(player?.Username ?? "Unknown")</a>
                            @if (endorsedUserIds.Contains(memberId))
                            {
                                <span>Evaluation Logged</span>
                            }
                            else
                            {
                                <select id="endorsement-@memberId">
                                    <option value="MVP">MVP (+5)</option>
                                    <option value="Leader">Leader (+4)</option>
                                    <option value="Good Teammate" selected>Good Teammate (+3)</option>
                                    <option value="Chill">Chill (+2)</option>
                                    <option value="Leaver">Leaver (-3)</option>
                                    <option value="Toxic">Toxic (-5)</option>
                                    <option value="AFK">AFK (-3)</option>
                                </select>
                                <button onclick="submitEndorsement('@Model.Id', '@memberId', this)">Submit</button>
                            }
                        </div>
                    }
                </div>
            }

            <!-- Join / Status info -->
            <div>
                @if (isMember)
                {
                    <p>Tactical Comms Established</p>
                    @if (!string.IsNullOrEmpty(Model.DiscordLink))
                    {
                        <a href="@Model.DiscordLink" target="_blank">DISCORD CHANNEL</a>
                    }
                    <button onclick="leaveLobby()">ABANDON MISSION</button>
                }
                else if (pendingApp != null)
                {
                    <p>Recruitment verification in Progress</p>
                    <button onclick="cancelApplication('@pendingApp.Id')">CANCEL REQUEST</button>
                }
                else
                {
                    @if (!Model.IsRecruiting)
                    {
                        <p>Recruitment Closed</p>
                    }
                    else
                    {
                        <button id="joinBtn">REQUEST DEPLOYMENT</button>
                    }
                }
            </div>

            <!-- Sidebar -->
            <div>
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=@hostName" width="48" height="48" />
                <a href="@Url.Action("FriendProfile", "User", new { id = hostName })">@hostName</a>
                
                <p>Mission Protocols</p>
                @foreach (var mood in Model.Moods) { <span>@mood</span> }
            </div>
        </div>
    </main>
}

@section Scripts {
    <script>
        document.getElementById('joinBtn')?.addEventListener('click', function() {
            var btn = this;
            btn.disabled = true;
            fetch('@Url.Action("Apply", "Lobby", new { id = Model.Id })', {
                method: 'POST',
                headers: { 'RequestVerificationToken': document.getElementsByName('__RequestVerificationToken')[0]?.value }
            }).then(() => location.reload());
        });

        function recruitApplicant(appId, btn) {
            btn.disabled = true;
            fetch('/Lobby/Recruit/' + appId, {
                method: 'POST',
                headers: { 'RequestVerificationToken': document.getElementsByName('__RequestVerificationToken')[0]?.value }
            }).then(() => location.reload());
        }

        function rejectApplicant(appId, btn) {
            if(!confirm('Reject?')) return;
            btn.disabled = true;
            fetch('/Lobby/Reject/' + appId, {
                method: 'POST',
                headers: { 'RequestVerificationToken': document.getElementsByName('__RequestVerificationToken')[0]?.value }
            }).then(() => location.reload());
        }

        function kickMember(userId, btn) {
            if(!confirm('Kick?')) return;
            btn.disabled = true;
            const formData = new FormData();
            formData.append('lobbyId', '@Model.Id');
            formData.append('memberId', userId);
            fetch('/Lobby/Kick', {
                method: 'POST',
                body: formData,
                headers: { 'RequestVerificationToken': document.getElementsByName('__RequestVerificationToken')[0]?.value }
            }).then(() => location.reload());
        }

        function cancelApplication(appId) {
            if(!confirm('Cancel?')) return;
            fetch('/Lobby/CancelApplication/' + '@Model.Id', {
                method: 'DELETE',
                headers: { 'RequestVerificationToken': document.getElementsByName('__RequestVerificationToken')[0]?.value }
            }).then(() => location.reload());
        }

        function leaveLobby() {
            if(!confirm('Leave?')) return;
            fetch('/Lobby/CancelApplication/' + '@Model.Id', {
                method: 'DELETE',
                headers: { 'RequestVerificationToken': document.getElementsByName('__RequestVerificationToken')[0]?.value }
            }).then(() => location.reload());
        }

        function toggleRecruitment(id) {
            fetch('/Lobby/ToggleRecruitment/' + id, {
                method: 'POST',
                headers: { 'RequestVerificationToken': document.getElementsByName('__RequestVerificationToken')[0]?.value }
            }).then(() => location.reload());
        }

        function completeSession(id) {
            if(!confirm('Complete?')) return;
            fetch('/Lobby/CompleteSession/' + id, {
                method: 'POST',
                headers: { 'RequestVerificationToken': document.getElementsByName('__RequestVerificationToken')[0]?.value }
            }).then(() => location.reload());
        }

        function submitEndorsement(lobbyId, targetUserId, btn) {
            const select = document.getElementById(`endorsement-${targetUserId}`);
            const type = select.value;
            btn.disabled = true;
            fetch(`/Lobby/EndorseMember?lobbyId=${lobbyId}&targetUserId=${targetUserId}&type=${encodeURIComponent(type)}`, {
                method: 'POST',
                headers: { 'RequestVerificationToken': document.getElementsByName('__RequestVerificationToken')[0]?.value }
            }).then(() => location.reload());
        }

        function initCountdown() {
            const el = document.getElementById('countdown');
            if (!el) return;
            const deadline = new Date(el.dataset.deadline);
            const display = el.querySelector('p');
            setInterval(() => {
                const now = new Date();
                const diff = deadline - now;
                if (diff <= 0) { display.innerText = "EXPIRED"; return; }
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const secs = Math.floor((diff % (1000 * 60)) / 1000);
                display.innerText = `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }, 1000);
        }
        document.addEventListener('DOMContentLoaded', initCountdown);
    </script>
}
